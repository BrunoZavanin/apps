<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KidzPaper - Math Shopkeeper</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Nunito:wght@400;700;900&family=Courier+Prime:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-grad-1: #ff9966;
            --bg-grad-2: #ff5e62;
            --main-color: #d35400;
            --accent-color: #f1c40f;
            --paper-bg: #fffdf0;
            --a4-width: 210mm;
            --a4-height: 297mm;
        }
        [data-theme="ocean"]  { --bg-grad-1:#2193b0; --bg-grad-2:#6dd5ed; --main-color:#0277bd; --accent-color:#00e5ff; --paper-bg:#f0faff; }
        [data-theme="forest"] { --bg-grad-1:#56ab2f; --bg-grad-2:#a8e063; --main-color:#2e7d32; --accent-color:#cddc39; --paper-bg:#f1f8e9; }
        [data-theme="berry"]  { --bg-grad-1:#ec008c; --bg-grad-2:#fc6767; --main-color:#c2185b; --accent-color:#ff80ab; --paper-bg:#fff0f5; }
        [data-theme="royal"]  { --bg-grad-1:#614385; --bg-grad-2:#516395; --main-color:#4527a0; --accent-color:#b388ff; --paper-bg:#f3e5f5; }

        * { box-sizing: border-box; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        body { margin: 0; font-family: 'Nunito', sans-serif; background: linear-gradient(135deg, var(--bg-grad-1), var(--bg-grad-2)); display: flex; justify-content: center; min-height: 100vh; }

        .settings-panel { width: 360px; background: rgba(0,0,0,0.9); padding: 20px; height: 100vh; position: sticky; top: 0; overflow-y: auto; color: white; border-right: 1px solid rgba(255,255,255,0.1); scrollbar-width: thin; z-index: 10; }
        .panel-header { font-family: 'Fredoka', sans-serif; font-size: 1.5rem; color: var(--accent-color); margin-bottom: 20px; text-align: center; text-transform: uppercase; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .control-group { margin-bottom: 15px; border-bottom: 1px dashed #444; padding-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 700; color: var(--accent-color); font-size: 0.75rem; text-transform: uppercase; }
        select, input[type="text"], input[type="number"] { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #555; background: #222; color: white; margin-bottom: 5px; font-family: 'Nunito'; }
        select:focus, input:focus { border-color: var(--accent-color); outline: none; }
        .checkbox-wrapper { display: flex; align-items: center; gap: 10px; cursor: pointer; margin-top: 10px; }
        .checkbox-wrapper input { width: auto; transform: scale(1.3); accent-color: var(--accent-color); }
        .btn-gen { width: 100%; padding: 12px; background: var(--accent-color); color: #000; font-weight: 900; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; font-family: 'Fredoka'; text-transform: uppercase; transition: transform 0.1s; box-shadow: 0 4px 0px rgba(0,0,0,0.2); }
        .btn-gen:active { transform: translateY(4px); box-shadow: none; }
        .btn-print { width: 100%; padding: 12px; background: transparent; border: 2px solid var(--accent-color); border-radius: 8px; color: var(--accent-color); font-weight: 900; cursor: pointer; margin-top: 10px; }

        /* Lang badge shown inside currency label area */
        .lang-badge { display: inline-block; margin-left: 6px; padding: 1px 7px; border-radius: 8px; font-size: 0.65rem; font-weight: 900; background: var(--accent-color); color: #000; vertical-align: middle; }

        /* WORKSHEET */
        .worksheet-wrapper { background: white; width: var(--a4-width); height: var(--a4-height); position: relative; margin: 20px; box-shadow: 0 0 40px rgba(0,0,0,0.5); display: flex; flex-direction: column; overflow: hidden; }
        .shop-awning { height: 35px; width: 100%; background: repeating-linear-gradient(45deg, var(--bg-grad-2), var(--bg-grad-2) 20px, #ffffff 20px, #ffffff 40px); border-bottom: 4px solid rgba(0,0,0,0.1); }
        .shop-header { text-align: center; padding: 10px 10px 5px 10px; background: #fafafa; border-bottom: 2px dashed #ddd; flex-shrink: 0; }
        .shop-title { font-family: 'Fredoka'; font-size: 2.2rem; color: var(--main-color); margin: 0; text-transform: uppercase; line-height: 1; }
        .shop-subtitle { color: #888; font-size: 0.8rem; font-weight: bold; letter-spacing: 1px; text-transform: uppercase; }
        .catalog-area { padding: 10px; background: var(--paper-bg); border-bottom: 4px solid var(--main-color); flex-shrink: 0; }
        .catalog-title { text-align: center; font-weight: 900; color: var(--main-color); margin-bottom: 5px; font-size: 0.9rem; text-transform: uppercase; }
        .catalog-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; }
        .catalog-item { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 4px; display: flex; flex-direction: column; align-items: center; text-align: center; }
        .cat-icon { font-size: 1.6rem; margin-bottom: 0px; line-height: 1.2; }
        .cat-name { font-size: 0.65rem; font-weight: 700; color: #555; line-height: 1.1; height: 2em; overflow: hidden; display: flex; align-items: center; }
        .cat-price { background: var(--main-color); color: white; padding: 1px 6px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; margin-top: 2px; font-family: 'Courier Prime'; }
        .receipts-area { flex-grow: 1; padding: 25px 30px; background: #f4f4f4; display: grid; align-content: start; }
        .layout-2 { grid-template-columns: 1fr; grid-template-rows: 1fr 1fr; gap: 40px; padding: 40px; }
        .layout-4 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 30px; }
        .receipt { background: white; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.1)); padding: 0; display: flex; flex-direction: column; position: relative; height: 100%; }
        .receipt::before, .receipt::after { content: ""; position: absolute; left: 0; width: 100%; height: 6px; background-size: 12px 12px; }
        .receipt::before { top: -6px; background: linear-gradient(135deg, transparent 50%, white 50%), linear-gradient(45deg, white 50%, transparent 50%); background-size: 12px 12px; background-position: top left; background-repeat: repeat-x; }
        .receipt::after { bottom: -6px; background: linear-gradient(135deg, white 50%, transparent 50%), linear-gradient(45deg, transparent 50%, white 50%); background-size: 12px 12px; background-position: bottom left; background-repeat: repeat-x; }
        .rec-header { text-align: center; padding: 8px 5px 4px; border-bottom: 1px dashed #ccc; }
        .rec-title { font-family: 'Courier Prime'; font-weight: 900; font-size: 1rem; }
        .rec-body { padding: 15px; flex-grow: 1; font-family: 'Courier Prime'; font-size: 0.85rem; display: flex; flex-direction: column; justify-content: space-between; }
        .rec-list { flex-grow: 1; }
        .rec-line { display: flex; justify-content: space-between; margin-bottom: 6px; border-bottom: 1px dotted #eee; }
        .rec-item-name { display: flex; align-items: center; gap: 4px; }
        .rec-total-section { margin-top: 10px; border-top: 2px dashed #333; padding-top: 10px; }
        .rec-row-bold { display: flex; justify-content: space-between; font-weight: 900; font-size: 1rem; margin-bottom: 4px; align-items: center; }
        .rec-input-box { border: 2px solid #ccc; width: 80px; height: 25px; display: inline-block; background: #fafafa; color: #d00; font-family: 'Courier Prime'; text-align: right; padding-right: 4px; font-size: 0.9rem; }
        .show-ans .rec-input-box { border-color: transparent; background: transparent; }
        .ws-footer { text-align: center; padding: 10px; font-size: 0.65rem; color: #888; font-family: 'Nunito'; border-top: 1px solid #eee; background: white; z-index: 5; position: absolute; bottom: 0; width: 100%; }

        @media print {
            body { background: white; display: block; }
            .settings-panel { display: none; }
            .worksheet-wrapper { margin: 0; box-shadow: none; width: 100%; height: 100vh; page-break-after: always; padding: 0; }
            .receipt { break-inside: avoid; }
            @page { margin: 0; }
        }
    </style>
</head>
<body data-theme="sunset">

    <div class="settings-panel">
        <div class="panel-header">üè™ MATH SHOPKEEPER</div>

        <div class="control-group">
            <label>1. Design Theme</label>
            <select id="themeSelect" onchange="updateTheme()">
                <option value="sunset" selected>üåÖ Sunset Orange</option>
                <option value="ocean">üåä Ocean Blue</option>
                <option value="forest">üå≤ Forest Green</option>
                <option value="berry">üçì Berry Pink</option>
                <option value="royal">üëë Royal Purple</option>
            </select>
        </div>

        <div class="control-group">
            <label>2. Currency & Settings
                <span class="lang-badge" id="langBadge">üá∫üá∏ EN</span>
            </label>
            <select id="currency" onchange="onCurrencyChange()">
                <option value="USD" selected>üá∫üá∏ USD ($) - Decimal</option>
                <option value="EUR">üá™üá∫ EUR (‚Ç¨) - Decimal</option>
                <option value="GBP">üá¨üáß GBP (¬£) - Decimal</option>
                <option value="AUD">üá¶üá∫ AUD ($) - Decimal</option>
                <option value="SGD">üá∏üá¨ SGD ($) - Decimal</option>
                <option value="CNY">üá®üá≥ CNY (¬•) - Decimal</option>
                <option value="IDR">üáÆüá© IDR (Rp) - No Decimal</option>
                <option value="JPY">üáØüáµ JPY (¬•) - No Decimal</option>
                <option value="KRW">üá∞üá∑ KRW (‚Ç©) - No Decimal</option>
                <option value="INR">üáÆüá≥ INR (‚Çπ) - Decimal</option>
                <option value="BRL">üáßüá∑ BRL (R$) - Portugu√™s (BR)</option>
                <option value="CUSTOM">‚úèÔ∏è CUSTOM (Your Symbol)</option>
            </select>
            <input type="text" id="customSymbol" placeholder="Enter Symbol (e.g. ‚Ç±)" style="display:none; margin-top:5px;" oninput="generateData()">

            <label style="margin-top:10px; font-weight:400;" id="lblReceiptsPerPage">Receipts per Page (Max 4)</label>
            <select id="receiptCount" onchange="generateData()">
                <option value="2" id="opt2Receipts">2 Receipts (Large)</option>
                <option value="4" selected id="opt4Receipts">4 Receipts (Standard)</option>
            </select>
        </div>

        <div class="control-group">
            <label>3. <span id="lblSection3">Labels & Text (Editable)</span></label>
            <div style="display:flex; gap:5px; margin-bottom:5px;">
                <input type="text" id="lblTotal"  value="TOTAL"  oninput="render()">
                <input type="text" id="lblCash"   value="CASH"   oninput="render()">
                <input type="text" id="lblChange" value="CHANGE" oninput="render()">
            </div>
            <input type="text" id="shopName"     value="MATH SHOPKEEPER"                   oninput="render()" placeholder="Shop Name">
            <input type="text" id="shopSubtitle" value="OFFICIAL PRICE LIST & ORDER FORMS" oninput="render()" placeholder="Subtitle">
            <input type="text" id="catalogTitle" value="--- CATALOG ---"                   oninput="render()" placeholder="Catalog Header">
            <input type="text" id="footerText"   value="Generated with OrbitLogic"         oninput="render()" placeholder="Footer">
        </div>

        <div class="control-group">
            <label>4. <span id="lblSection4">Shop Content</span></label>
            <select id="shopTheme" onchange="generateData()">
                <option value="fruit"  id="optFruit">üçé Fruit Stand</option>
                <option value="toys"   id="optToys">üß∏ Toy Store</option>
                <option value="bakery" id="optBakery">ü•ê Bakery</option>
                <option value="school" id="optSchool">‚úèÔ∏è Stationery</option>
                <option value="cafe"   id="optCafe">üçî Burger Cafe</option>
            </select>

            <label style="margin-top:10px; font-weight:400;" id="lblItemsPerReceipt">Items per Receipt</label>
            <select id="itemCount" onchange="generateData()">
                <option value="2" id="opt2Items">2 Items</option>
                <option value="3" selected id="opt3Items">3 Items</option>
                <option value="4" id="opt4Items">4 Items</option>
                <option value="random" id="optRandItems">üé≤ Random (2-5 Items)</option>
            </select>

            <label class="checkbox-wrapper">
                <input type="checkbox" id="showSolution" onchange="render()">
                <span id="lblShowAnswer">Show Answer Key</span>
            </label>
        </div>

        <button class="btn-gen" id="btnReroll" onclick="generateData()">üé≤ RE-ROLL ITEMS & PRICES</button>
        <button class="btn-print" onclick="window.print()" id="btnPrint">üñ®Ô∏è PRINT WORKSHEET</button>
        <button class="btn-print" onclick="saveAsImage()" id="btnSave">üíæ SAVE AS IMAGE</button>
    </div>

    <div class="worksheet-wrapper" id="wsWrapper">
        <div class="shop-awning"></div>
        <div class="shop-header">
            <h1 class="shop-title" id="outShopName">MATH SHOPKEEPER</h1>
            <div class="shop-subtitle" id="outSubtitle">OFFICIAL PRICE LIST & ORDER FORMS</div>
        </div>
        <div class="catalog-area">
            <div class="catalog-title" id="outCatalogTitle">--- CATALOG ---</div>
            <div class="catalog-grid" id="catalogGrid"></div>
        </div>
        <div class="receipts-area layout-4" id="receiptsArea"></div>
        <div class="ws-footer" id="outFooter">Generated with OrbitLogic</div>
    </div>

    <script>
        // ‚îÄ‚îÄ Language Packs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const langPacks = {
            en: {
                badge:        'üá∫üá∏ EN',
                shopName:     'MATH SHOPKEEPER',
                shopSubtitle: 'OFFICIAL PRICE LIST & ORDER FORMS',
                catalogTitle: '--- CATALOG ---',
                lblTotal:     'TOTAL',
                lblCash:      'CASH',
                lblChange:    'CHANGE',
                footerText:   'Generated with OrbitLogic',
                receipt:      'RECEIPT',
                section3:     'Labels & Text (Editable)',
                section4:     'Shop Content',
                receiptsPerPage: 'Receipts per Page (Max 4)',
                itemsPerReceipt: 'Items per Receipt',
                showAnswer:   'Show Answer Key',
                reroll:       'üé≤ RE-ROLL ITEMS & PRICES',
                opt2r: '2 Receipts (Large)', opt4r: '4 Receipts (Standard)',
                opt2i: '2 Items', opt3i: '3 Items', opt4i: '4 Items', optRi: 'üé≤ Random (2-5 Items)',
                optFruit: 'üçé Fruit Stand', optToys: 'üß∏ Toy Store', optBakery: 'ü•ê Bakery',
                optSchool: '‚úèÔ∏è Stationery', optCafe: 'üçî Burger Cafe',
                itemNames: {
                    fruit:  ['Apple','Banana','Grapes','Melon','Berry','Pineapple','Cherry','Avocado','Corn','Carrot','Potato','Broccoli'],
                    toys:   ['Teddy','Car','Train','Kite','Ball','Drum','Puzzle','Rocket','Boat','Dino','Unicorn','Bricks'],
                    bakery: ['Croissant','Bagel','Baguette','Pretzel','Pancake','Waffle','Donut','Cookie','Cake','Cupcake','Pie','Bread'],
                    school: ['Pencil','Pen','Ruler','Scissors','Book','Clip','Bag','Crayon','Brush','Palette','Pin','Ruler'],
                    cafe:   ['Burger','Fries','Hotdog','Pizza','Soda','Cone','Popcorn','Chicken','Salad','Donut','Taco','Sandwich']
                }
            },
            pt: {
                badge:        'üáßüá∑ PT',
                shopName:     'MERCADINHO MATEM√ÅTICO',
                shopSubtitle: 'LISTA DE PRE√áOS E FORMUL√ÅRIOS DE COMPRA',
                catalogTitle: '--- CAT√ÅLOGO ---',
                lblTotal:     'TOTAL',
                lblCash:      'PAGAMENTO',
                lblChange:    'TROCO',
                footerText:   'Gerado com OrbitLogic',
                receipt:      'RECIBO',
                section3:     'Textos (Edit√°vel)',
                section4:     'Tema da Loja',
                receiptsPerPage: 'Recibos por P√°gina (M√°x 4)',
                itemsPerReceipt: 'Itens por Recibo',
                showAnswer:   'Mostrar Gabarito',
                reroll:       'üé≤ GERAR NOVOS ITENS E PRE√áOS',
                opt2r: '2 Recibos (Grande)', opt4r: '4 Recibos (Padr√£o)',
                opt2i: '2 Itens', opt3i: '3 Itens', opt4i: '4 Itens', optRi: 'üé≤ Aleat√≥rio (2-5 Itens)',
                optFruit: 'üçé Banca de Frutas', optToys: 'üß∏ Loja de Brinquedos', optBakery: 'ü•ê Padaria',
                optSchool: '‚úèÔ∏è Papelaria', optCafe: 'üçî Lanchonete',
                itemNames: {
                    fruit:  ['Ma√ß√£','Banana','Uva','Mel√£o','Morango','Abacaxi','Cereja','Abacate','Milho','Cenoura','Batata','Br√≥colis'],
                    toys:   ['Ursinho','Carrinho','Trem','Pipa','Bola','Tambor','Quebra-cabe√ßa','Foguete','Barco','Dinossauro','Unic√≥rnio','Blocos'],
                    bakery: ['Croissant','Rosquinha','Baguete','Pretzel','Panqueca','Waffle','Donuts','Biscoito','Bolo','Cupcake','Torta','P√£o'],
                    school: ['L√°pis','Caneta','R√©gua','Tesoura','Livro','Clipe','Mochila','Giz de cera','Pincel','Paleta','Alfinete','Esquadro'],
                    cafe:   ['Hamb√∫rguer','Batata frita','Cachorro-quente','Pizza','Refrigerante','Sorvete','Pipoca','Frango','Salada','Donuts','Taco','Sandu√≠che']
                }
            }
        };

        // ‚îÄ‚îÄ Currency Config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const currencies = {
            USD:    { s:'$',   dec:2 },
            EUR:    { s:'‚Ç¨',   dec:2 },
            GBP:    { s:'¬£',   dec:2 },
            AUD:    { s:'A$',  dec:2 },
            SGD:    { s:'S$',  dec:2 },
            CNY:    { s:'¬•',   dec:2 },
            IDR:    { s:'Rp',  dec:0 },
            JPY:    { s:'¬•',   dec:0 },
            KRW:    { s:'‚Ç©',   dec:0 },
            INR:    { s:'‚Çπ',   dec:2 },
            BRL:    { s:'R$',  dec:2 },
            CUSTOM: { s:'',    dec:2 }
        };

        // ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let appState = { catalog: [], receipts: [] };
        let currentLang = 'en';

        // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function getLang() { return langPacks[currentLang]; }

        function updateTheme() {
            document.body.setAttribute('data-theme', document.getElementById('themeSelect').value);
        }

        // Called every time currency changes ‚Äî the ONLY trigger for language switch
        function onCurrencyChange() {
            const curr = document.getElementById('currency').value;

            // Show/hide custom symbol input
            document.getElementById('customSymbol').style.display = curr === 'CUSTOM' ? 'block' : 'none';

            // Auto-switch language based on currency
            const newLang = curr === 'BRL' ? 'pt' : 'en';
            if (newLang !== currentLang) {
                currentLang = newLang;
                applyLangToUI();   // update all sidebar labels & worksheet text fields
            }

            generateData();
        }

        // Push all language strings into the UI (sidebar + worksheet inputs) without regenerating data
        function applyLangToUI() {
            const L = getLang();

            // Badge
            document.getElementById('langBadge').innerText = L.badge;

            // Sidebar labels
            document.getElementById('lblSection3').innerText     = L.section3;
            document.getElementById('lblSection4').innerText     = L.section4;
            document.getElementById('lblReceiptsPerPage').innerText = L.receiptsPerPage;
            document.getElementById('lblItemsPerReceipt').innerText = L.itemsPerReceipt;
            document.getElementById('lblShowAnswer').innerText   = L.showAnswer;
            document.getElementById('btnReroll').innerText       = L.reroll;

            // Receipt count options
            document.getElementById('opt2Receipts').innerText = L.opt2r;
            document.getElementById('opt4Receipts').innerText = L.opt4r;

            // Item count options
            document.getElementById('opt2Items').innerText   = L.opt2i;
            document.getElementById('opt3Items').innerText   = L.opt3i;
            document.getElementById('opt4Items').innerText   = L.opt4i;
            document.getElementById('optRandItems').innerText = L.optRi;

            // Shop theme options
            document.getElementById('optFruit').innerText  = L.optFruit;
            document.getElementById('optToys').innerText   = L.optToys;
            document.getElementById('optBakery').innerText = L.optBakery;
            document.getElementById('optSchool').innerText = L.optSchool;
            document.getElementById('optCafe').innerText   = L.optCafe;

            // Worksheet text inputs (only update if they still match the previous lang's defaults
            // or if it's the first time ‚Äî so manual edits are preserved only across re-rolls)
            document.getElementById('shopName').value     = L.shopName;
            document.getElementById('shopSubtitle').value = L.shopSubtitle;
            document.getElementById('catalogTitle').value = L.catalogTitle;
            document.getElementById('lblTotal').value     = L.lblTotal;
            document.getElementById('lblCash').value      = L.lblCash;
            document.getElementById('lblChange').value    = L.lblChange;
            document.getElementById('footerText').value   = L.footerText;
        }

        // ‚îÄ‚îÄ Price formatting ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function formatPrice(amount, currKey) {
            const conf   = currencies[currKey];
            let   symbol = currKey === 'CUSTOM'
                ? (document.getElementById('customSymbol').value || '$')
                : conf.s;

            if (conf.dec === 0) {
                return symbol + '\u00a0' + amount.toLocaleString('en-US');
            } else if (currKey === 'BRL') {
                // Formato brasileiro: R$ 1.234,50
                return symbol + '\u00a0' + amount.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            } else {
                return symbol + amount.toFixed(conf.dec);
            }
        }

        // ‚îÄ‚îÄ Generate Data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function generateData() {
            const themeKey      = document.getElementById('shopTheme').value;
            const currKey       = document.getElementById('currency').value;
            const receiptCount  = parseInt(document.getElementById('receiptCount').value);
            const itemCountVal  = document.getElementById('itemCount').value;
            const L             = getLang();
            const translatedNames = L.itemNames[themeKey];

            // Emojis from master dataset, names from lang pack
            const masterItems = {
                fruit:  ['üçé','üçå','üçá','üçâ','üçì','üçç','üçí','ü•ë','üåΩ','ü•ï','ü•î','ü•¶'],
                toys:   ['üß∏','üöó','üöÇ','ü™Å','‚öΩ','ü•Å','üß©','üöÄ','üö§','ü¶ñ','ü¶Ñ','üß±'],
                bakery: ['ü•ê','ü•Ø','ü•ñ','ü•®','ü•û','üßá','üç©','üç™','üç∞','üßÅ','ü•ß','üçû'],
                school: ['‚úèÔ∏è','üñäÔ∏è','üìè','‚úÇÔ∏è','üìì','üìé','üéí','üñçÔ∏è','üñåÔ∏è','üé®','üìå','üìê'],
                cafe:   ['üçî','üçü','üå≠','üçï','ü•§','üç¶','üçø','üçó','ü•ó','üç©','üåÆ','ü•™']
            };

            // 1. Catalog with prices
            appState.catalog = masterItems[themeKey].map((icon, idx) => {
                let price;
                if (currKey === 'IDR') {
                    price = (Math.floor(Math.random() * 49) + 2) * 1000;
                    if (Math.random() > 0.6) price += 500;
                } else if (currKey === 'JPY' || currKey === 'KRW') {
                    price = (Math.floor(Math.random() * 19) + 1) * 100;
                } else if (currKey === 'BRL') {
                    // R$ 0,50 a R$ 15,00 em m√∫ltiplos de R$ 0,25 ‚Äî troco pedag√≥gico
                    price = (Math.floor(Math.random() * 58) + 2) * 0.25;
                    price = Math.round(price * 100) / 100;
                } else {
                    let raw = Math.random() * 19.5 + 0.5;
                    price = Math.round(raw * 20) / 20; // nearest 0.05
                }
                return { i: icon, n: translatedNames[idx], price };
            });

            // 2. Receipts
            appState.receipts = [];
            for (let i = 0; i < receiptCount; i++) {
                let itemsToBuy = [], total = 0;
                let shuffled   = [...appState.catalog].sort(() => 0.5 - Math.random());
                let numItems   = itemCountVal === 'random'
                    ? Math.floor(Math.random() * 4) + 2
                    : parseInt(itemCountVal);

                for (let k = 0; k < numItems; k++) {
                    let item     = shuffled[k];
                    let qty      = Math.floor(Math.random() * 3) + 1;
                    let subtotal = Math.round(item.price * qty * 100) / 100;
                    total       += subtotal;
                    itemsToBuy.push({ ...item, qty, subtotal });
                }
                total = Math.round(total * 100) / 100;

                // Payment ‚Äî clean round numbers per currency
                let payment;
                if (currKey === 'IDR') {
                    payment = Math.ceil(total / 5000) * 5000;
                    if (payment <= total) payment += 5000;
                } else if (currKey === 'JPY' || currKey === 'KRW') {
                    payment = Math.ceil(total / 500) * 500;
                    if (payment <= total) payment += 500;
                } else if (currKey === 'BRL') {
                    // Paga com nota: R$5, R$10, R$20 ou R$50
                    const notas = [5, 10, 20, 50];
                    payment = notas.find(n => n > total) || 50;
                    // 40% chance: usa valor arredondado menor (ex: total R$7,25 ‚Üí paga R$7,50)
                    if (Math.random() > 0.6) {
                        let alt = Math.ceil(total / 0.5) * 0.5;
                        if (alt > total) payment = Math.round(alt * 100) / 100;
                    }
                } else {
                    payment = Math.ceil(total / 5) * 5;
                    if (payment <= total) payment += 5;
                    if (Math.random() > 0.7) payment = Math.ceil(total) + 1;
                }

                let change = Math.round((payment - total) * 100) / 100;
                appState.receipts.push({ items: itemsToBuy, total, payment, change, id: 1001 + i });
            }

            render();
        }

        // ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function render() {
            const currKey      = document.getElementById('currency').value;
            const showSolution = document.getElementById('showSolution').checked;
            const receiptCount = document.getElementById('receiptCount').value;
            const L            = getLang();

            // Worksheet text from inputs
            document.getElementById('outShopName').innerText    = document.getElementById('shopName').value;
            document.getElementById('outSubtitle').innerText    = document.getElementById('shopSubtitle').value;
            document.getElementById('outCatalogTitle').innerText = document.getElementById('catalogTitle').value;
            document.getElementById('outFooter').innerText      = document.getElementById('footerText').value;

            const lblTotal  = document.getElementById('lblTotal').value;
            const lblCash   = document.getElementById('lblCash').value;
            const lblChange = document.getElementById('lblChange').value;

            // Catalog
            const catGrid = document.getElementById('catalogGrid');
            catGrid.innerHTML = '';
            appState.catalog.forEach(item => {
                catGrid.innerHTML += `
                    <div class="catalog-item">
                        <div class="cat-icon">${item.i}</div>
                        <div class="cat-name">${item.n}</div>
                        <div class="cat-price">${formatPrice(item.price, currKey)}</div>
                    </div>`;
            });

            // Receipts
            const receiptArea = document.getElementById('receiptsArea');
            receiptArea.className = `receipts-area layout-${receiptCount}`;
            receiptArea.innerHTML = '';

            const wrapper = document.getElementById('wsWrapper');
            showSolution ? wrapper.classList.add('show-ans') : wrapper.classList.remove('show-ans');

            appState.receipts.forEach(rec => {
                let linesHtml = rec.items.map(it => `
                    <div class="rec-line">
                        <div class="rec-item-name">${it.qty} x ${it.i} ${it.n}</div>
                        <div>${formatPrice(it.subtotal, currKey)}</div>
                    </div>`).join('');

                receiptArea.innerHTML += `
                    <div class="receipt">
                        <div class="rec-header">
                            <div class="rec-title">${L.receipt} #${rec.id}</div>
                        </div>
                        <div class="rec-body">
                            <div class="rec-list">${linesHtml}</div>
                            <div class="rec-total-section">
                                <div class="rec-row-bold">
                                    <span>${lblTotal}</span>
                                    <span class="rec-input-box" data-ans="${formatPrice(rec.total, currKey)}"></span>
                                </div>
                                <div class="rec-row-bold" style="color:#555;">
                                    <span>${lblCash}</span>
                                    <span>${formatPrice(rec.payment, currKey)}</span>
                                </div>
                                <div class="rec-row-bold" style="color:var(--main-color); margin-top:4px;">
                                    <span>${lblChange}</span>
                                    <span class="rec-input-box" data-ans="${formatPrice(rec.change, currKey)}"></span>
                                </div>
                            </div>
                        </div>
                    </div>`;
            });

            // Fill answer boxes
            document.querySelectorAll('.rec-input-box').forEach(box => {
                box.innerText = showSolution ? box.getAttribute('data-ans') : '';
            });
        }

        window.onload = () => {
            updateTheme();
            generateData();
        };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script>
    function saveAsImage() {
        const target = document.getElementById("wsWrapper");
        const isChrome = /Chrome/.test(navigator.userAgent) && !/Firefox/.test(navigator.userAgent);
        html2canvas(target, { scale: isChrome ? 1.5 : 2, useCORS: true, backgroundColor: "#ffffff" }).then(canvas => {
            const link = document.createElement("a");
            link.download = "math-shopkeeper-worksheet.png";
            link.href = canvas.toDataURL("image/png");
            link.click();
        });
    }
    </script>
</body>
</html>
