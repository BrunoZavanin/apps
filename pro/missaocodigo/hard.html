<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KidzPaper - Robot Simple Coding</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-grad-1: #1e3c72;
            --bg-grad-2: #2a5298;
            --main-color: #2a5298;
            --accent-color: #00d2ff;
            --text-color: #333;
            --a4-width: 210mm;
            --a4-height: 297mm;
            --grid-n: 4;
        }

        * { box-sizing: border-box; -webkit-print-color-adjust: exact; }
        body { margin: 0; font-family: 'Nunito', sans-serif; background: linear-gradient(135deg, var(--bg-grad-1), var(--bg-grad-2)); display: flex; justify-content: center; min-height: 100vh; transition: background 0.5s; }

        /* Sidebar */
        .settings-panel { width: 360px; background: rgba(0,0,0,0.95); padding: 20px; height: 100vh; position: sticky; top: 0; overflow-y: auto; color: white; border-right: 1px solid rgba(255,255,255,0.1); scrollbar-width: thin; }
        .panel-header { font-family: 'Fredoka', sans-serif; font-size: 1.5rem; color: var(--accent-color); margin-bottom: 20px; text-align: center; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .control-group { margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 700; color: var(--accent-color); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; }
        select, input[type="text"], input[type="number"] { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #444; background: #222; color: white; margin-bottom: 5px; font-family: 'Nunito'; font-size: 0.9rem; }
        select:focus, input:focus { border-color: var(--accent-color); outline: none; background: #333; }

        .theme-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .theme-btn { padding: 10px; border: 2px solid #444; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.8rem; font-weight: bold; background: #222; color: #fff; transition: 0.2s; }
        .theme-btn:hover, .theme-btn.active { border-color: white; background: #333; }
        .color-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; border: 1px solid rgba(255,255,255,0.5); }

        .slider-container { display: flex; align-items: center; gap: 10px; }
        input[type=range] { flex-grow: 1; accent-color: var(--accent-color); cursor: pointer; }
        .val-display { width: 30px; text-align: center; font-weight: bold; font-size: 0.9rem; }

        .checkbox-wrapper { display: flex; align-items: center; gap: 10px; cursor: pointer; margin-top: 5px; }
        .checkbox-wrapper input { width: auto; transform: scale(1.3); accent-color: var(--accent-color); }

        .btn-gen { width: 100%; padding: 12px; background: var(--accent-color); color: #000; font-weight: 900; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; font-family: 'Fredoka'; text-transform: uppercase; transition: transform 0.1s; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .btn-gen:active { transform: scale(0.98); }
        .btn-print { width: 100%; padding: 12px; background: transparent; border: 2px solid var(--accent-color); border-radius: 8px; color: var(--accent-color); font-weight: 900; cursor: pointer; margin-top: 10px; }
        .btn-print:hover { background: rgba(255,255,255,0.1); }

        /* Difficulty legend in sidebar */
        .diff-legend { display: flex; flex-direction: column; gap: 4px; margin-top: 8px; }
        .diff-row { display: flex; align-items: center; gap: 8px; font-size: 0.75rem; color: #ccc; }
        .diff-badge { padding: 2px 8px; border-radius: 10px; font-size: 0.65rem; font-weight: 900; letter-spacing: 0.5px; }
        .badge-easy   { background: #27ae60; color: white; }
        .badge-medium { background: #f39c12; color: white; }
        .badge-hard   { background: #c0392b; color: white; }
        .badge-boss   { background: #8e44ad; color: white; }

        /* Worksheet */
        .worksheet-wrapper { background: white; width: var(--a4-width); height: var(--a4-height); padding: 10mm; position: relative; margin: 20px; box-shadow: 0 0 40px rgba(0,0,0,0.6); display: flex; flex-direction: column; overflow: hidden; }

        .ws-header { display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 3px solid var(--main-color); padding-bottom: 10px; margin-bottom: 15px; flex-shrink: 0; }
        .ws-title { font-family: 'Fredoka'; font-size: 2.2rem; color: var(--main-color); text-transform: uppercase; line-height: 1; margin-bottom: 5px; }
        .ws-instr { font-size: 0.9rem; color: #555; max-width: 450px; line-height: 1.3; }
        .ws-info { text-align: right; font-size: 0.9rem; color: #444; font-weight: bold; line-height: 1.8; }
        .ws-info span { color: var(--main-color); }

        .puzzles-container { display: grid; gap: 15px; flex-grow: 1; min-height: 0; }
        .layout-2 { grid-template-rows: 1fr 1fr; grid-template-columns: 1fr; }
        .layout-4 { grid-template-rows: 1fr 1fr; grid-template-columns: 1fr 1fr; }
        .layout-6 { grid-template-rows: 1fr 1fr 1fr; grid-template-columns: 1fr 1fr; }

        .puzzle-card { border: 2px solid #ddd; border-radius: 12px; padding: 8px; display: flex; flex-direction: column; background: #fafafa; overflow: hidden; border-color: rgba(0,0,0,0.1); }

        /* Puzzle header with badge + step count */
        .puzzle-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-family: 'Fredoka'; flex-shrink: 0; }
        .puzzle-header-left { display: flex; align-items: center; gap: 6px; color: var(--main-color); font-weight: bold; }
        .puzzle-step-count { font-size: 0.72rem; color: #888; font-family: 'Nunito'; font-weight: 700; }

        /* Difficulty badge on card */
        .card-diff-badge { padding: 2px 8px; border-radius: 10px; font-size: 0.65rem; font-weight: 900; letter-spacing: 0.5px; }

        /* Coordinate labels */
        .grid-outer { display: flex; flex-direction: column; align-items: center; max-height: 100%; max-width: 100%; }
        .coord-top { display: flex; margin-left: 20px; }  /* offset for row labels */
        .coord-top-cell { display: flex; align-items: center; justify-content: center; font-size: 0.6rem; font-weight: 900; color: var(--main-color); font-family: 'Fredoka'; opacity: 0.7; }
        .grid-with-rows { display: flex; align-items: stretch; }
        .coord-left { display: flex; flex-direction: column; margin-right: 2px; }
        .coord-left-cell { display: flex; align-items: center; justify-content: center; font-size: 0.6rem; font-weight: 900; color: var(--main-color); font-family: 'Fredoka'; opacity: 0.7; }

        .grid-wrapper { flex-grow: 1; display: flex; align-items: center; justify-content: center; min-height: 0; width: 100%; }
        .grid-map { display: grid; margin: 0 auto; border: 2px solid var(--main-color); background: var(--main-color); aspect-ratio: 1/1; height: auto; max-height: 100%; max-width: 100%;
            grid-template-columns: repeat(var(--grid-n), minmax(0, 1fr));
            grid-template-rows: repeat(var(--grid-n), minmax(0, 1fr));
        }

        /* Font sizes */
        .layout-2 .grid-cell { font-size: 2.5rem; }
        .layout-4 .grid-cell { font-size: 1.8rem; }
        .layout-6 .grid-cell { font-size: 1.2rem; }
        .layout-2.g-size-6 .grid-cell { font-size: 1.8rem; }
        .layout-4.g-size-5 .grid-cell { font-size: 1.5rem; }
        .layout-4.g-size-6 .grid-cell { font-size: 1.2rem; }
        .layout-6.g-size-5 .grid-cell { font-size: 1.0rem; }
        .layout-6.g-size-6 .grid-cell { font-size: 0.9rem; }
        .layout-6 .puzzle-header { font-size: 0.9rem; }
        .layout-6 .puzzle-card { padding: 5px; }

        /* Coord cell sizes mirror grid cells */
        .layout-2 .coord-top-cell,
        .layout-2 .coord-left-cell { width: calc(2.5rem * 1.5); height: calc(2.5rem * 1.5); }
        .layout-4 .coord-top-cell,
        .layout-4 .coord-left-cell { width: calc(1.8rem * 1.5); height: calc(1.8rem * 1.5); }
        .layout-6 .coord-top-cell,
        .layout-6 .coord-left-cell { width: calc(1.2rem * 1.5); height: calc(1.2rem * 1.5); font-size: 0.5rem; }

        .grid-cell { background: white; display: flex; align-items: center; justify-content: center; position: relative; border: 1px solid #eee; width: 100%; height: 100%; overflow: hidden; }

        /* Path arrows */
        .path-arrow { display: none; font-weight: 900; font-size: 1.2em; z-index: 1; text-shadow: 0 0 2px white; }
        .show-ans .path-arrow { display: block; color: #d00; opacity: 1; transform: scale(1.1); }

        /* Input area */
        .input-area { margin-top: 5px; border-top: 1px dashed #ccc; padding-top: 5px; flex-shrink: 0; }
        .arrow-guide { display: flex; gap: 10px; justify-content: center; margin-bottom: 3px; color: #888; font-size: 0.8rem; }

        /* NEW: individual step boxes */
        .code-slots { display: flex; flex-wrap: wrap; gap: 4px; align-items: center; min-height: 34px; padding: 3px 0; }
        .code-slot { width: 28px; height: 28px; border: 2px solid #ccc; border-radius: 5px; display: flex; align-items: center; justify-content: center; background: white; font-size: 0.9rem; flex-shrink: 0; }
        .layout-6 .code-slot { width: 22px; height: 22px; font-size: 0.75rem; }

        /* Solution shown inside slots */
        .code-slot .solution-arrow { display: none; color: #d00; font-weight: bold; font-size: 1rem; }
        .show-ans .code-slot .solution-arrow { display: block; }

        /* Fallback code-box for very long solutions */
        .code-box { width: 100%; height: 38px; border: 2px solid #ccc; border-radius: 6px; display: flex; align-items: center; padding: 0 10px; color: #aaa; font-style: italic; font-size: 0.9rem; margin-top: 5px; overflow: hidden; white-space: nowrap; }
        .layout-6 .code-box { height: 28px; font-size: 0.8rem; }
        .solution-text { display: none; color: #d00; font-weight: bold; letter-spacing: 3px; font-style: normal; width: 100%; }
        .show-ans .solution-text { display: block; }

        @media print {
            body { background: white; display: block; }
            .settings-panel { display: none; }
            .worksheet-wrapper { margin: 0; box-shadow: none; width: 100%; height: 100vh; page-break-after: always; padding: 10mm; }
            .puzzle-card { break-inside: avoid; border-color: #aaa; }
            .grid-map { border-color: #000; }
            .show-ans .code-slot .solution-arrow { display: block; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
    </style>
</head>
<body>

    <div class="settings-panel">
        <div class="panel-header">ğŸ¤– Robot Simple Coding</div>

        <div class="control-group">
            <label>1. Language</label>
            <select id="langSelect" onchange="updateLanguage()">
                <option value="en" selected>ğŸ‡ºğŸ‡¸ English</option>
                <option value="pt">ğŸ‡§ğŸ‡· PortuguÃªs (BR)</option>
                <option value="id">ğŸ‡®ğŸ‡© Indonesia</option>
                <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
                <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
                <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
                <option value="ms">ğŸ‡²ğŸ‡¾ Melayu</option>
                <option value="ar">ğŸ‡¸ğŸ‡¦ Arabic</option>
                <option value="ja">ğŸ‡¯ğŸ‡µ Japanese</option>
            </select>
        </div>

        <div class="control-group">
            <label>2. Customize Text</label>
            <input type="text" id="inpTitle" value="CODING QUEST" oninput="renderText()">
            <input type="text" id="inpInstr" value="Guide the character to the goal! Write the arrows." oninput="renderText()">
            <div style="display:flex; gap:5px;">
                <input type="text" id="inpName" value="Name" oninput="renderText()">
                <input type="text" id="inpDate" value="Date" oninput="renderText()">
            </div>
            <input type="text" id="inpWrite" value="Write Code:" oninput="generateAll()">
        </div>

        <div class="control-group">
            <label>3. Color Scheme</label>
            <div class="theme-grid">
                <div class="theme-btn" onclick="applyPreset('#2a5298','#00d2ff','#1e3c72')" style="border-left:4px solid #2a5298;">
                    <span class="color-dot" style="background:#2a5298"></span> Ocean
                </div>
                <div class="theme-btn" onclick="applyPreset('#c0392b','#f1c40f','#870000')" style="border-left:4px solid #c0392b;">
                    <span class="color-dot" style="background:#c0392b"></span> Mars
                </div>
                <div class="theme-btn" onclick="applyPreset('#27ae60','#f39c12','#145a32')" style="border-left:4px solid #27ae60;">
                    <span class="color-dot" style="background:#27ae60"></span> Forest
                </div>
                <div class="theme-btn" onclick="applyPreset('#8e44ad','#ff7979','#5b2c6f')" style="border-left:4px solid #8e44ad;">
                    <span class="color-dot" style="background:#8e44ad"></span> Berry
                </div>
            </div>
        </div>

        <div class="control-group">
            <label>4. Game Settings</label>
            <label style="font-weight:400;font-size:0.8rem;margin-top:5px;">Theme</label>
            <select id="themeSelect" onchange="generateAll()">
                <option value="space">ğŸ¤– Space Robot (Robot â†’ Battery)</option>
                <option value="farm">ğŸ´ Horse Ride (Horse â†’ Grass)</option>
                <option value="traffic">ğŸš— City Drive (Car â†’ Flag)</option>
                <option value="nature">ğŸ¦‹ Butterfly (Butterfly â†’ Flower)</option>
                <option value="shapes">ğŸ”· Shapes (Circle â†’ Star)</option>
            </select>

            <label style="font-weight:400;font-size:0.8rem;margin-top:10px;">Layout</label>
            <select id="questCount" onchange="generateAll()">
                <option value="2">2 Quests (Large)</option>
                <option value="4" selected>4 Quests (Standard)</option>
                <option value="6">6 Quests (Compact)</option>
            </select>

            <label style="font-weight:400;font-size:0.8rem;margin-top:10px;">Grid Size</label>
            <select id="gridSize" onchange="generateAll()">
                <option value="4">4 Ã— 4 (Easy)</option>
                <option value="5" selected>5 Ã— 5 (Medium)</option>
                <option value="6">6 Ã— 6 (Hard)</option>
            </select>

            <label style="font-weight:400;font-size:0.8rem;margin-top:10px;">Obstacles (base)</label>
            <div class="slider-container">
                <input type="range" id="obstacleCount" min="1" max="10" value="3"
                    oninput="document.getElementById('obsVal').innerText=this.value; generateAll();">
                <span id="obsVal" class="val-display">3</span>
            </div>

            <!-- Progressive difficulty toggle -->
            <label class="checkbox-wrapper" style="margin-top:12px;">
                <input type="checkbox" id="progDiff" checked onchange="generateAll()">
                <span style="color:var(--accent-color);font-weight:bold;">Progressive Difficulty</span>
            </label>
            <div class="diff-legend" id="diffLegend">
                <div class="diff-row"><span class="diff-badge badge-easy">EASY</span> Quest #1 â€” fewer obstacles</div>
                <div class="diff-row"><span class="diff-badge badge-medium">MED</span> Quest #2 â€” base obstacles</div>
                <div class="diff-row"><span class="diff-badge badge-hard">HARD</span> Quest #3 â€” more obstacles</div>
                <div class="diff-row"><span class="diff-badge badge-boss">BOSS</span> Quest #4+ â€” maximum challenge</div>
            </div>

            <label class="checkbox-wrapper" style="margin-top:12px;">
                <input type="checkbox" id="showCoords" checked onchange="generateAll()">
                <span style="color:var(--accent-color);font-weight:bold;">Show Grid Coordinates</span>
            </label>

            <label class="checkbox-wrapper" style="margin-top:8px;">
                <input type="checkbox" id="showSolution" onchange="toggleSolution()">
                <span style="color:var(--accent-color);font-weight:bold;">Show Answer Key</span>
            </label>
        </div>

        <button class="btn-gen" onclick="generateAll()">ğŸ² SHUFFLE (GENERATE NEW)</button>
        <button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ PRINT PDF</button>
        <button class="btn-print" onclick="saveAsImage()">ğŸ’¾ SAVE AS IMAGE</button>
    </div>

    <div class="worksheet-wrapper" id="wsWrapper">
        <div class="ws-header">
            <div>
                <div class="ws-title" id="outTitle">CODING QUEST</div>
                <div class="ws-instr" id="outInstr">Guide the character to the goal! Write the arrows.</div>
            </div>
            <div class="ws-info">
                <span id="outName">Name</span>: _________________<br>
                <span id="outDate">Date</span>: _________________
            </div>
        </div>
        <div class="puzzles-container layout-4" id="puzzlesContainer"></div>
    </div>

    <script>
        const themes = {
            space:   { player:'ğŸ¤–', goal:'ğŸ”‹', wall:'â˜„ï¸',  bg:'#f0f4ff' },
            farm:    { player:'ğŸ´', goal:'ğŸŒ¾', wall:'ğŸª¨',  bg:'#f5fff0' },
            traffic: { player:'ğŸš—', goal:'ğŸ', wall:'ğŸš§',  bg:'#fffbf0' },
            nature:  { player:'ğŸ¦‹', goal:'ğŸŒ»', wall:'ğŸ•¸ï¸', bg:'#fff0f5' },
            shapes:  { player:'ğŸ”µ', goal:'â­', wall:'â¬›',  bg:'#ffffff' }
        };

        const translations = {
            en: { t:"ROBOT CODING QUEST", i:"Guide the character to the goal! Write the arrow code.", n:"Name", d:"Date", w:"Write Code:", q:"QUEST",
                  diff:{ easy:"EASY", medium:"MED", hard:"HARD", boss:"BOSS" }, steps:"steps" },
            pt: { t:"DESAFIO DE PROGRAMAÃ‡ÃƒO", i:"Guie o personagem atÃ© o objetivo! Escreva as setas.", n:"Nome", d:"Data", w:"Escreva o CÃ³digo:", q:"MISSÃƒO",
                  diff:{ easy:"FÃCIL", medium:"MÃ‰DIO", hard:"DIFÃCIL", boss:"CHEFÃƒO" }, steps:"passos" },
            id: { t:"MISI KODING ROBOT", i:"Bantu karakter mencapai tujuan! Tulis arah panahnya.", n:"Nama", d:"Tanggal", w:"Tulis Kode:", q:"MISI",
                  diff:{ easy:"MUDAH", medium:"SEDANG", hard:"SULIT", boss:"BOS" }, steps:"langkah" },
            de: { t:"ROBOTER-CODIERUNG", i:"FÃ¼hre die Figur zum Ziel! Schreibe die Pfeile.", n:"Name", d:"Datum", w:"Code:", q:"AUFGABE",
                  diff:{ easy:"LEICHT", medium:"MITTEL", hard:"SCHWER", boss:"BOSS" }, steps:"Schritte" },
            fr: { t:"QUÃŠTE DE CODAGE", i:"Guide le personnage vers l'objectif ! Ã‰cris les flÃ¨ches.", n:"Nom", d:"Date", w:"Code:", q:"QUÃŠTE",
                  diff:{ easy:"FACILE", medium:"MOYEN", hard:"DIFFICILE", boss:"BOSS" }, steps:"pas" },
            es: { t:"MISIÃ“N DE CÃ“DIGO", i:"Â¡GuÃ­a al personaje a la meta! Escribe las flechas.", n:"Nombre", d:"Fecha", w:"CÃ³digo:", q:"MISIÃ“N",
                  diff:{ easy:"FÃCIL", medium:"MEDIO", hard:"DIFÃCIL", boss:"JEFE" }, steps:"pasos" },
            ms: { t:"MISI KODING ROBOT", i:"Pandu watak ke matlamat! Tulis kod anak panah.", n:"Nama", d:"Tarikh", w:"Tulis Kod:", q:"MISI",
                  diff:{ easy:"MUDAH", medium:"SEDANG", hard:"SUSAH", boss:"BOS" }, steps:"langkah" },
            ar: { t:"Ù…Ù‡Ù…Ø© Ø§Ù„Ø¨Ø±Ù…Ø¬Ø©", i:"ÙˆØ¬Ù‡ Ø§Ù„Ø´Ø®ØµÙŠØ© Ù„Ù„Ù‡Ø¯Ù! Ø§ÙƒØªØ¨ Ø§Ù„Ø£Ø³Ù‡Ù….", n:"Ø§Ù„Ø§Ø³Ù…", d:"Ø§Ù„ØªØ§Ø±ÙŠØ®", w:"Ø§Ù„ÙƒÙˆØ¯:", q:"Ù…Ù‡Ù…Ø©",
                  diff:{ easy:"Ø³Ù‡Ù„", medium:"Ù…ØªÙˆØ³Ø·", hard:"ØµØ¹Ø¨", boss:"Ø²Ø¹ÙŠÙ…" }, steps:"Ø®Ø·ÙˆØ§Øª" },
            ja: { t:"ãƒ­ãƒœãƒƒãƒˆã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°", i:"ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ã‚´ãƒ¼ãƒ«ã«å°ã“ã†ï¼çŸ¢å°ã‚’æ›¸ã„ã¦ã­ã€‚", n:"åå‰", d:"æ—¥ä»˜", w:"ã‚³ãƒ¼ãƒ‰:", q:"ã‚¯ã‚¨ã‚¹ãƒˆ",
                  diff:{ easy:"ã‹ã‚“ãŸã‚“", medium:"ãµã¤ã†", hard:"ã‚€ãšã‹ã—ã„", boss:"ãƒœã‚¹" }, steps:"ã‚¹ãƒ†ãƒƒãƒ—" }
        };

        // Difficulty config: obstacle multiplier + badge style per quest index (1-based)
        const diffConfig = [
            { key:'easy',   obstMult: 0.4, badge:'badge-easy'   },
            { key:'medium', obstMult: 1.0, badge:'badge-medium' },
            { key:'hard',   obstMult: 1.6, badge:'badge-hard'   },
            { key:'boss',   obstMult: 2.2, badge:'badge-boss'   },
            { key:'boss',   obstMult: 2.5, badge:'badge-boss'   },
            { key:'boss',   obstMult: 2.5, badge:'badge-boss'   },
        ];

        const LETTERS = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";

        function getLang() {
            return translations[document.getElementById('langSelect').value] || translations['en'];
        }

        function applyPreset(main, acc, bgGrad) {
            const r = document.documentElement;
            r.style.setProperty('--main-color', main);
            r.style.setProperty('--accent-color', acc);
            r.style.setProperty('--bg-grad-1', bgGrad);
            r.style.setProperty('--bg-grad-2', main);
        }

        function updateLanguage() {
            const L = getLang();
            document.getElementById('inpTitle').value = L.t;
            document.getElementById('inpInstr').value = L.i;
            document.getElementById('inpName').value  = L.n;
            document.getElementById('inpDate').value  = L.d;
            document.getElementById('inpWrite').value = L.w;
            // Update legend labels
            const leg = document.getElementById('diffLegend');
            if (leg) {
                const rows = leg.querySelectorAll('.diff-row');
                const diffs = ['easy','medium','hard','boss'];
                rows.forEach((row, i) => {
                    const badge = row.querySelector('.diff-badge');
                    if (badge) badge.innerText = L.diff[diffs[i]];
                });
            }
            generateAll();
        }

        function renderText() {
            const L = getLang();
            document.getElementById('outTitle').innerText = document.getElementById('inpTitle').value;
            document.getElementById('outInstr').innerText = document.getElementById('inpInstr').value;
            document.getElementById('outName').innerText  = document.getElementById('inpName').value;
            document.getElementById('outDate').innerText  = document.getElementById('inpDate').value;
            document.querySelectorAll('.lbl-write').forEach(el => el.innerText = document.getElementById('inpWrite').value);
        }

        function toggleSolution() {
            const wrap = document.getElementById('wsWrapper');
            document.getElementById('showSolution').checked
                ? wrap.classList.add('show-ans')
                : wrap.classList.remove('show-ans');
        }

        function generateAll() {
            const container = document.getElementById('puzzlesContainer');
            const count     = parseInt(document.getElementById('questCount').value);
            const size      = parseInt(document.getElementById('gridSize').value);
            const baseObs   = parseInt(document.getElementById('obstacleCount').value);
            const progOn    = document.getElementById('progDiff').checked;
            const showC     = document.getElementById('showCoords').checked;

            document.documentElement.style.setProperty('--grid-n', size);
            container.className = `puzzles-container layout-${count} g-size-${size}`;
            container.innerHTML = '';

            for (let i = 1; i <= count; i++) {
                const cfg = progOn ? diffConfig[Math.min(i-1, diffConfig.length-1)] : diffConfig[1];
                const obs = Math.max(1, Math.round(baseObs * cfg.obstMult));
                container.innerHTML += createPuzzle(i, size, obs, cfg, showC, progOn);
            }
            renderText();
            toggleSolution();
        }

        function createPuzzle(index, size, obstacleCount, diffCfg, showCoords, progOn) {
            const themeKey = document.getElementById('themeSelect').value;
            const theme    = themes[themeKey];
            const L        = getLang();
            const writeLabel = document.getElementById('inpWrite').value || L.w;

            // â”€â”€ Map generation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            let grid, path, start, end;
            let attempts = 0;

            while (!path && attempts < 60) {
                grid  = Array(size).fill(null).map(() => Array(size).fill(0));
                start = [Math.floor(Math.random()*size), Math.floor(Math.random()*size)];
                do {
                    end = [Math.floor(Math.random()*size), Math.floor(Math.random()*size)];
                } while (start[0]===end[0] && start[1]===end[1]);

                for (let w = 0; w < obstacleCount; w++) {
                    let wx, wy, tries = 0;
                    do {
                        wx = Math.floor(Math.random()*size);
                        wy = Math.floor(Math.random()*size);
                        tries++;
                    } while (tries < 100 && ((wx===start[0]&&wy===start[1]) || (wx===end[0]&&wy===end[1]) || grid[wx][wy]===1));
                    grid[wx][wy] = 1;
                }
                path = findShortestPath(grid, start, end, size);
                attempts++;
            }

            if (!path) { path = []; grid = Array(size).fill(null).map(() => Array(size).fill(0)); }

            // â”€â”€ Build path map & arrow list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            let pathMap  = {};
            let arrowList = [];
            const ARROW_MAP = { down:'â¬‡ï¸', up:'â¬†ï¸', right:'â¡ï¸', left:'â¬…ï¸' };

            if (path.length > 1) {
                for (let k = 0; k < path.length - 1; k++) {
                    let [r1,c1] = path[k], [r2,c2] = path[k+1];
                    let dir = r2>r1?'down': r2<r1?'up': c2>c1?'right':'left';
                    let arrow = ARROW_MAP[dir];
                    pathMap[`${r1},${c1}`] = arrow;
                    arrowList.push(arrow);
                }
            }

            // â”€â”€ Quest ID (seed-style number) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const questId = Math.floor(Math.random()*9000)+1000;

            // â”€â”€ Difficulty badge HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const diffLabel = L.diff[diffCfg.key] || diffCfg.key.toUpperCase();
            const badgeHtml = progOn
                ? `<span class="card-diff-badge ${diffCfg.badge}">${diffLabel}</span>`
                : '';

            // â”€â”€ Step count â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const stepCount = arrowList.length;
            const stepHtml  = `<span class="puzzle-step-count">ğŸ“ ${stepCount} ${L.steps}</span>`;

            // â”€â”€ Grid HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            let cellsHtml = '';
            for (let r = 0; r < size; r++) {
                for (let c = 0; c < size; c++) {
                    let content = '';
                    if (r===start[0]&&c===start[1])     content = theme.player;
                    else if (r===end[0]&&c===end[1])    content = theme.goal;
                    else if (grid[r][c]===1)            content = theme.wall;

                    const arrowOverlay = pathMap[`${r},${c}`]
                        ? `<div class="path-arrow" style="position:absolute;">${pathMap[`${r},${c}`]}</div>`
                        : '';

                    cellsHtml += `<div class="grid-cell" style="background:${theme.bg};">
                        <span style="z-index:2">${content}</span>${arrowOverlay}</div>`;
                }
            }
            const gridHtml = `<div class="grid-map">${cellsHtml}</div>`;

            // â”€â”€ Coordinate labels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            let coordHtml = '';
            if (showCoords) {
                // Top labels (A B Câ€¦)
                let topCells = '';
                for (let c = 0; c < size; c++) {
                    topCells += `<div class="coord-top-cell">${LETTERS[c]}</div>`;
                }
                // Left labels (1 2 3â€¦)
                let leftCells = '';
                for (let r = 0; r < size; r++) {
                    leftCells += `<div class="coord-left-cell">${r+1}</div>`;
                }
                // Wrap grid with coords
                coordHtml = `
                    <div class="grid-outer">
                        <div class="coord-top" style="width:100%;">${topCells}</div>
                        <div class="grid-with-rows">
                            <div class="coord-left">${leftCells}</div>
                            ${gridHtml}
                        </div>
                    </div>`;
            } else {
                coordHtml = gridHtml;
            }

            // â”€â”€ Individual step boxes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            let slotsHtml = arrowList.map(arrow =>
                `<div class="code-slot"><span class="solution-arrow">${arrow}</span></div>`
            ).join('');

            return `
                <div class="puzzle-card">
                    <div class="puzzle-header">
                        <div class="puzzle-header-left">
                            ${badgeHtml}
                            <span>${L.q} #${index}</span>
                            <span style="font-size:0.65rem;color:#aaa;font-family:'Nunito';font-weight:600;">#${questId}</span>
                        </div>
                        ${stepHtml}
                    </div>
                    <div class="grid-wrapper">${coordHtml}</div>
                    <div class="input-area">
                        <div class="arrow-guide">â¬†ï¸ â¬‡ï¸ â¬…ï¸ â¡ï¸</div>
                        <div style="font-size:0.78rem;font-weight:bold;margin-bottom:3px;" class="lbl-write">${writeLabel}</div>
                        <div class="code-slots">${slotsHtml}</div>
                    </div>
                </div>`;
        }

        function findShortestPath(grid, start, end, size) {
            let queue   = [[start]];
            let visited = new Set([start.toString()]);
            while (queue.length > 0) {
                let path    = queue.shift();
                let [r, c]  = path[path.length - 1];
                if (r===end[0] && c===end[1]) return path;
                for (let [dr, dc] of [[-1,0],[1,0],[0,-1],[0,1]]) {
                    let nr = r+dr, nc = c+dc;
                    const key = [nr,nc].toString();
                    if (nr>=0&&nr<size&&nc>=0&&nc<size&&grid[nr][nc]===0&&!visited.has(key)) {
                        visited.add(key);
                        queue.push([...path,[nr,nc]]);
                    }
                }
            }
            return null;
        }

        window.onload = () => { updateLanguage(); };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script>
    function saveAsImage() {
        const target = document.getElementById("wsWrapper");
        const isChrome = /Chrome/.test(navigator.userAgent) && !/Firefox/.test(navigator.userAgent);
        html2canvas(target, { scale: isChrome ? 1.5 : 2, useCORS: true, backgroundColor: "#ffffff" }).then(canvas => {
            const link = document.createElement("a");
            link.download = "robot-coding-worksheet.png";
            link.href = canvas.toDataURL("image/png");
            link.click();
        });
    }
    </script>
</body>
</html>
