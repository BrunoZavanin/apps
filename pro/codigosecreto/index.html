<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KidzPaper - Secret Spy</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Nunito:wght@400;700;900&family=Courier+Prime:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-main: linear-gradient(135deg, #1a1a1a, #2c3e50);
            --accent: #00ff88;
            --card-border: #2ecc71;
            --card-inner: #f0fff4;
            --text-main: #1a1a1a;
            --btn-primary: linear-gradient(145deg, #00ff88, #00cc6a);
            --a4-width: 210mm;
        }
        [data-theme="spy"]    { --bg-main: linear-gradient(135deg, #0f0c29, #302b63, #24243e); --accent: #00f260; --card-border: #0575e6; --card-inner: #e6f1ff; --text-main: #000; --btn-primary: linear-gradient(to right, #0575e6, #00f260); }
        [data-theme="pink"]   { --bg-main: linear-gradient(135deg, #ff9a9e, #fecfef); --accent: #ff0055; --card-border: #ff6b6b; --card-inner: #fff0f5; --text-main: #590018; --btn-primary: linear-gradient(145deg, #ff758c, #ff7eb3); }
        [data-theme="jungle"] { --bg-main: linear-gradient(135deg, #134e5e, #71b280); --accent: #ffeb3b; --card-border: #2e7d32; --card-inner: #f1f8e9; --text-main: #1b5e20; --btn-primary: linear-gradient(145deg, #66bb6a, #43a047); }
        [data-theme="sunset"] { --bg-main: linear-gradient(135deg, #ff512f, #dd2476); --accent: #ffd700; --card-border: #ff6b6b; --card-inner: #fff5e6; --text-main: #8e2de2; --btn-primary: linear-gradient(145deg, #ff9966, #ff5e62); }
        * { box-sizing: border-box; -webkit-print-color-adjust: exact; }
        body { margin: 0; font-family: 'Nunito', sans-serif; background: var(--bg-main); display: flex; justify-content: center; min-height: 100vh; }
        .settings-panel { width: 350px; background: rgba(0,0,0,0.8); backdrop-filter: blur(15px); padding: 20px; height: 100vh; position: sticky; top: 0; overflow-y: auto; border-right: 1px solid rgba(255,255,255,0.1); color: white; }
        .panel-header { font-family: 'Fredoka', sans-serif; font-size: 1.4rem; color: var(--accent); margin-bottom: 15px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px; }
        .control-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 4px; font-weight: 700; color: var(--accent); text-transform: uppercase; font-size: 0.7rem; }
        select, input, textarea { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: white; outline: none; margin-bottom: 5px; font-size: 0.9rem; font-family: 'Nunito'; }
        textarea { resize: vertical; min-height: 80px; }
        option { background: #333; }
        .btn-gen { width: 100%; padding: 12px; border-radius: 10px; border: none; background: var(--btn-primary); color: #000; font-weight: 900; cursor: pointer; font-family: 'Fredoka'; margin-top: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: transform 0.1s; }
        .btn-gen:active { transform: scale(0.98); }
        .btn-print { width: 100%; padding: 12px; border-radius: 10px; border: 2px solid var(--accent); background: transparent; color: var(--accent); font-weight: 900; cursor: pointer; font-family: 'Fredoka'; margin-top: 10px; }
        .btn-toggle { background: #4b5563; border: 1px solid #9ca3af; color: white; box-shadow: none; }
        .lang-note { font-size: 0.68rem; color: #aaa; margin-top: 4px; line-height: 1.4; padding: 6px 8px; background: rgba(255,255,255,0.07); border-radius: 6px; }
        .worksheet-wrapper { background: white; width: var(--a4-width); padding: 15mm; color: #333; margin: 20px; min-height: 297mm; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.5); display: flex; flex-direction: column; }
        .top-secret-stamp { position: absolute; top: 20px; right: 20px; border: 3px solid #d00; color: #d00; padding: 5px 15px; font-family: 'Courier Prime', monospace; font-weight: bold; font-size: 1.5rem; transform: rotate(-10deg); opacity: 0.7; letter-spacing: 2px; }
        .ws-header { border-bottom: 4px solid var(--card-border); padding-bottom: 10px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: flex-end; }
        .ws-title-box h1 { margin: 0; font-family: 'Fredoka'; font-size: 2.2rem; color: var(--text-main); line-height: 1; text-transform: uppercase; }
        .ws-info-box { font-weight: 700; font-size: 0.9rem; text-align: right; line-height: 1.6; color: #555; }
        .input-line { display: inline-block; width: 150px; border-bottom: 2px solid #ccc; margin-left: 5px; height: 1rem; }
        .cipher-container { flex-grow: 1; display: flex; flex-direction: column; gap: 30px; }
        .message-row { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; padding: 20px; background: var(--card-inner); border-radius: 15px; border: 2px dashed var(--card-border); break-inside: avoid; page-break-inside: avoid; }
        .char-box { display: flex; flex-direction: column; align-items: center; gap: 20px; width: 45px; }
        .symbol { font-size: 2rem; width: 45px; height: 45px; background: white; border: 2px solid var(--card-border); border-radius: 8px; display: flex; align-items: center; justify-content: center; box-shadow: 3px 3px 0 rgba(0,0,0,0.1); }
        .answer-slot { width: 100%; height: 25px; border-bottom: 3px solid #333; display: flex; align-items: flex-end; justify-content: center; position: relative; }
        .answer-text { font-family: 'Fredoka', sans-serif; font-weight: bold; font-size: 1.2rem; color: #d00; margin-bottom: 2px; opacity: 0; transition: opacity 0.3s; }
        body.show-answers .answer-text { opacity: 1; }
        .spacer { width: 30px; }
        .decoder-section { margin-top: auto; border-top: 2px solid #eee; padding-top: 20px; }
        .decoder-title { font-family: 'Fredoka'; margin-bottom: 10px; text-align: center; color: var(--card-border); }
        .key-grid { display: grid; grid-template-columns: repeat(9, 1fr); gap: 8px; }
        .key-item { border: 1px solid #ccc; border-radius: 6px; padding: 4px; display: flex; flex-direction: column; align-items: center; font-size: 0.8rem; background: #fafafa; break-inside: avoid; page-break-inside: avoid; }
        .key-sym { font-size: 1.2rem; margin-bottom: 2px; }
        .key-char { font-weight: bold; font-family: 'Courier Prime', monospace; color: var(--text-main); }
        .ws-footer { margin-top: 15px; text-align: center; font-size: 0.7rem; color: #999; }
        @media print {
            body { background: white; }
            .settings-panel { display: none; }
            .worksheet-wrapper { margin: 0; box-shadow: none; width: 100%; min-height: 100vh; height: auto; display: block; }
            .message-row, .key-item, .decoder-section { break-inside: avoid; page-break-inside: avoid; }
            body.show-answers .answer-text { opacity: 1 !important; print-color-adjust: exact; -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body data-theme="spy">

    <div class="settings-panel">
        <div class="panel-header">üïµÔ∏è SPY MAKER</div>

        <div class="control-group">
            <label>üåç Worksheet Language</label>
            <select id="langSelect" onchange="applyLanguage()">
                <option value="en">üá∫üá∏ English</option>
                <option value="pt">üáßüá∑ Portugu√™s (BR)</option>
                <option value="id">üáÆüá© Indonesia</option>
                <option value="de">üá©üá™ Deutsch</option>
                <option value="fr">üá´üá∑ Fran√ßais</option>
                <option value="ms">üá≤üáæ Melayu</option>
                <option value="ar">üá∏üá¶ Arabic</option>
                <option value="ja">üáØüáµ Japanese</option>
            </select>
            <div class="lang-note" id="langNote"></div>
        </div>

        <div class="control-group">
            <label>Secret Message (Max 100 chars)</label>
            <textarea id="secretInput"></textarea>
        </div>

        <div class="control-group">
            <label>Cipher Symbols</label>
            <select id="symbolSet" onchange="render()">
                <option value="emoji_nature">üå≤ Nature Code</option>
                <option value="emoji_animals">üêæ Animal Code</option>
                <option value="emoji_shapes">üî∑ Shape Code</option>
                <option value="emoji_sports">‚öΩ Sport Code</option>
            </select>
        </div>

        <div class="control-group">
            <label>Difficulty</label>
            <select id="difficulty" onchange="render()">
                <option value="normal">Normal (Full Key)</option>
                <option value="hard">Hard (Partial Key - Missing vowels)</option>
            </select>
        </div>

        <hr style="opacity:0.2">

        <div class="control-group">
            <label>Title</label>
            <input type="text" id="custTitle" oninput="render()">
            <label>Instruction</label>
            <input type="text" id="custInstr" oninput="render()">
        </div>

        <div class="control-group">
            <label>Labels & Footer</label>
            <input type="text" id="lblAgent" placeholder="Agent Label" oninput="render()">
            <input type="text" id="lblDate" placeholder="Date Label" oninput="render()">
            <input type="text" id="custFooter" placeholder="Footer Text" oninput="render()">
        </div>

        <div class="control-group">
            <label>Theme</label>
            <select id="themeSelect" onchange="updateTheme()">
                <option value="spy">Spy Blue</option>
                <option value="pink">Candy Pink</option>
                <option value="jungle">Jungle Adventure</option>
                <option value="sunset">Sunset Vibe</option>
            </select>
        </div>

        <button class="btn-gen" onclick="render()">üîÑ ENCRYPT MESSAGE</button>
        <button class="btn-gen btn-toggle" onclick="toggleAnswers()">üëÅÔ∏è TOGGLE ANSWER KEY</button>
        <button class="btn-print" onclick="window.print()">üñ®Ô∏è PRINT MISSION</button>
        <button class="btn-print" onclick="saveAsImage()">üíæ SAVE AS IMAGE</button>
    </div>

    <div class="worksheet-wrapper">
        <div class="top-secret-stamp" id="out-stamp">CONFIDENTIAL</div>
        <div class="ws-header">
            <div class="ws-title-box">
                <h1 id="out-title">TOP SECRET MISSION</h1>
                <div id="out-instr" style="font-weight:600; color:#666; font-size:0.9rem; margin-top:5px;"></div>
            </div>
            <div class="ws-info-box">
                <div><span id="out-agent-label">Agent Name:</span> <span class="input-line"></span></div>
                <div><span id="out-date-label">Date:</span> <span class="input-line"></span></div>
                <div>Code ID: <span id="code-id">#001</span></div>
            </div>
        </div>
        <div class="cipher-container" id="message-container"></div>
        <div class="decoder-section">
            <div class="decoder-title" id="out-decoder-title">üîê DECODER KEY</div>
            <div class="key-grid" id="key-grid"></div>
        </div>
        <div class="ws-footer" id="out-footer"></div>
    </div>

    <script>
        const symbols = {
            emoji_nature:  ['üçé','üçê','üçä','üçã','üçå','üçâ','üçá','üçì','üçÑ','üçà','üçí','üçë','ü•≠','üçç','ü••','ü•ù','üçÖ','üçÜ','ü•ë','ü•¶','ü•¨','ü•í','üåΩ','ü•ï','ü•î','üç†'],
            emoji_animals: ['üêò','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üêí','üê∏','üêµ','üêî','üêß','üê¶','üê§','ü¶Ü','ü¶Ö','ü¶â','ü¶á','üê∫','üêó','üê¥'],
            emoji_shapes:  ['üî¥','üü†','üü°','üü¢','üîµ','üü£','üü§','‚ö´','‚ö™','üü•','üüß','üü®','üü©','üü¶','üü™','üü´','‚¨õ','‚¨ú','üî∫','üî∂','üî∑','üí†','üîò','üî≥','üî≤','üè≥Ô∏è'],
            emoji_sports:  ['‚öΩ','üèÄ','üèà','‚öæ','ü•é','üéæ','üèê','üèâ','üé±','ü•è','üèì','üè∏','üèí','üèë','ü•ç','üèè','‚õ≥','ü•ä','ü•ã','‚õ∏Ô∏è','üé£','ü§ø','üõπ','üõ∑','üèπ','üéØ']
        };

        const languages = {
            en: {
                alphabet: "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(''),
                vowels: ['A','E','I','O','U'],
                accentMap: {},
                latinBased: true,
                ui: { stamp:'CONFIDENTIAL', title:'TOP SECRET MISSION', instr:'Use the key below to decode the message:', agent:'Agent Name:', date:'Date:', footer:'Generated with OrbitLogic Secret Maker', decoderKey:'üîê DECODER KEY', note:'Cipher covers A‚ÄìZ.' },
                defaultMsg: "HELLO AGENT\nFIND THE TREASURE"
            },
            pt: {
                alphabet: "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(''),
                vowels: ['A','E','I','O','U'],
                accentMap: { '√Å':'A','√Ä':'A','√Ç':'A','√É':'A','√Ñ':'A','√â':'E','√ä':'E','√ã':'E','√ç':'I','√é':'I','√è':'I','√ì':'O','√î':'O','√ï':'O','√ñ':'O','√ö':'U','√õ':'U','√ú':'U','√á':'C','√ë':'N' },
                latinBased: true,
                ui: { stamp:'CONFIDENCIAL', title:'MISS√ÉO SECRETA', instr:'Use a chave abaixo para decifrar a mensagem:', agent:'Nome do Agente:', date:'Data:', footer:'Gerado com OrbitLogic Secret Maker', decoderKey:'üîê CHAVE DECODIFICADORA', note:'O cifrador usa A‚ÄìZ. Letras acentuadas (√Å, √É, √á‚Ä¶) usam a letra base no c√≥digo, mas aparecem com acento na resposta.' },
                defaultMsg: "OL√Å AGENTE\nENCONTRE O TESOURO"
            },
            id: {
                alphabet: "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(''),
                vowels: ['A','E','I','O','U'],
                accentMap: {},
                latinBased: true,
                ui: { stamp:'RAHASIA', title:'MISI RAHASIA', instr:'Gunakan kunci di bawah untuk memecahkan pesan:', agent:'Nama Agen:', date:'Tanggal:', footer:'Dibuat dengan OrbitLogic Secret Maker', decoderKey:'üîê KUNCI DEKODER', note:'Sandi menggunakan alfabet A‚ÄìZ.' },
                defaultMsg: "HALO AGEN\nTEMUKAN HARTA KARUN"
            },
            de: {
                alphabet: "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(''),
                vowels: ['A','E','I','O','U'],
                accentMap: { '√Ñ':'A','√ñ':'O','√ú':'U','√ü':'S' },
                latinBased: true,
                ui: { stamp:'GEHEIM', title:'GEHEIMMISSION', instr:'Benutze den Schl√ºssel unten, um die Nachricht zu entschl√ºsseln:', agent:'Agentenname:', date:'Datum:', footer:'Erstellt mit OrbitLogic Secret Maker', decoderKey:'üîê DECODER-SCHL√úSSEL', note:'Sonderzeichen (√Ñ‚ÜíA, √ñ‚ÜíO, √ú‚ÜíU, √ü‚ÜíS) auf Basiscode gemappt.' },
                defaultMsg: "HALLO AGENT\nFINDE DEN SCHATZ"
            },
            fr: {
                alphabet: "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(''),
                vowels: ['A','E','I','O','U'],
                accentMap: { '√Ä':'A','√Ç':'A','√Ü':'A','√â':'E','√à':'E','√ä':'E','√ã':'E','√é':'I','√è':'I','√î':'O','≈í':'O','√ô':'U','√õ':'U','√ú':'U','√á':'C','≈∏':'Y' },
                latinBased: true,
                ui: { stamp:'CONFIDENTIEL', title:'MISSION SECR√àTE', instr:"Utilise la cl√© ci-dessous pour d√©coder le message :", agent:"Nom de l'agent :", date:'Date :', footer:'Cr√©√© avec OrbitLogic Secret Maker', decoderKey:'üîê CL√â DE D√âCODAGE', note:'Caract√®res accentu√©s (√â‚ÜíE, √á‚ÜíC‚Ä¶) mapp√©s sur la lettre de base.' },
                defaultMsg: "BONJOUR AGENT\nTROUVE LE TRESOR"
            },
            ms: {
                alphabet: "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(''),
                vowels: ['A','E','I','O','U'],
                accentMap: {},
                latinBased: true,
                ui: { stamp:'SULIT', title:'MISI RAHSIA', instr:'Gunakan kunci di bawah untuk menyahkod mesej:', agent:'Nama Ejen:', date:'Tarikh:', footer:'Dijana dengan OrbitLogic Secret Maker', decoderKey:'üîê KUNCI DEKOD', note:'Sifer menggunakan abjad A‚ÄìZ.' },
                defaultMsg: "HELLO EJEN\nCARI HARTA KARUN"
            },
            ar: {
                alphabet: ['ÿß','ÿ®','ÿ™','ÿ´','ÿ¨','ÿ≠','ÿÆ','ÿØ','ÿ∞','ÿ±','ÿ≤','ÿ≥','ÿ¥','ÿµ','ÿ∂','ÿ∑','ÿ∏','ÿπ','ÿ∫','ŸÅ','ŸÇ','ŸÉ','ŸÑ','ŸÖ','ŸÜ','Ÿà'],
                vowels: ['ÿß','Ÿà'],
                accentMap: { 'Ÿâ':'ÿß','ÿ£':'ÿß','ÿ•':'ÿß','ÿ¢':'ÿß','ÿ©':'ÿ™','Ÿä':'Ÿà' },
                latinBased: false,
                ui: { stamp:'ÿ≥ÿ±Ÿä', title:'ŸÖŸáŸÖÿ© ÿ≥ÿ±Ÿäÿ©', instr:'ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÖŸÅÿ™ÿßÿ≠ ÿ£ÿØŸÜÿßŸá ŸÑŸÅŸÉ ÿ¥ŸÅÿ±ÿ© ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©:', agent:'ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ:', date:'ÿßŸÑÿ™ÿßÿ±ŸäÿÆ:', footer:'ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ§Ÿá ÿ®Ÿàÿßÿ≥ÿ∑ÿ© OrbitLogic Secret Maker', decoderKey:'üîê ŸÖŸÅÿ™ÿßÿ≠ ŸÅŸÉ ÿßŸÑÿ™ÿ¥ŸÅŸäÿ±', note:'ÿßŸÑÿ¥ŸÅÿ±ÿ© ÿ™ÿ≥ÿ™ÿÆÿØŸÖ 26 ÿ≠ÿ±ŸÅŸãÿß ŸÖŸÜ ÿßŸÑÿ£ÿ®ÿ¨ÿØŸäÿ© ÿßŸÑÿπÿ±ÿ®Ÿäÿ©.' },
                defaultMsg: "ŸÖÿ±ÿ≠ÿ®ÿß ÿπŸÖŸäŸÑŸä\nÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÉŸÜÿ≤"
            },
            ja: {
                alphabet: ['„Ç¢','„Ç§','„Ç¶','„Ç®','„Ç™','„Ç´','„Ç≠','„ÇØ','„Ç±','„Ç≥','„Çµ','„Ç∑','„Çπ','„Çª','„ÇΩ','„Çø','„ÉÅ','„ÉÑ','„ÉÜ','„Éà','„Éä','„Éã','„Éå','„Éç','„Éé','„Éè'],
                vowels: ['„Ç¢','„Ç§','„Ç¶','„Ç®','„Ç™'],
                accentMap: {},
                latinBased: false,
                ui: { stamp:'Ê•µÁßò', title:'„Å≤„Åø„Å§„ÅÆ„Éü„ÉÉ„Ç∑„Éß„É≥', instr:'‰∏ã„ÅÆ„Ç≠„Éº„Çí‰Ωø„Å£„Å¶„É°„ÉÉ„Çª„Éº„Ç∏„ÇíËß£Ë™≠„Åó„Çà„ÅÜÔºö', agent:'„Ç®„Éº„Ç∏„Çß„É≥„ÉàÂêçÔºö', date:'Êó•‰ªòÔºö', footer:'OrbitLogic Secret Maker„Åß‰ΩúÊàê', decoderKey:'üîê „Éá„Ç≥„Éº„ÉÄ„Éº„Ç≠„Éº', note:'ÊöóÂè∑„ÅØ„Ç´„Çø„Ç´„Éä26ÊñáÂ≠ó„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ' },
                defaultMsg: "„Åì„Çì„Å´„Å°„ÅØ„Ç®„Éº„Ç∏„Çß„É≥„Éà\n„Åü„Åã„Çâ„Çí„Åï„Åå„Åõ"
            }
        };

        // ‚îÄ‚îÄ‚îÄ Message Banks (15+ per language) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const messageBanks = {
            en: [
                "HELLO AGENT\nFIND THE TREASURE",
                "THE EAGLE HAS LANDED\nMISSION COMPLETE",
                "DANGER AHEAD\nSTAY IN THE SHADOWS",
                "MEET AT MIDNIGHT\nBRING THE MAP",
                "THE SPY IS NEAR\nDO NOT TRUST ANYONE",
                "CODE RED ALERT\nEVACUATE NOW",
                "LOOK UNDER THE BRIDGE\nTHE PACKAGE IS THERE",
                "FOLLOW THE STARS\nNORTH IS YOUR GUIDE",
                "THE LION SLEEPS\nWAIT FOR THE SIGNAL",
                "CRACK THE CODE\nSAVE THE WORLD",
                "JUMP OVER THE WALL\nRUN TO FREEDOM",
                "THE MOON IS FULL\nTIME TO ACT",
                "FIND THE SECRET DOOR\nHIDDEN IN THE CAVE",
                "TRUST NO ONE\nYOU ARE ALONE",
                "THE TREASURE IS BURIED\nDIG SEVEN STEPS EAST",
                "OPERATION SUNRISE\nBEGINS AT DAWN"
            ],
            pt: [
                "OL√Å AGENTE\nENCONTRE O TESOURO",
                "A √ÅGUIA POUSOU\nMISS√ÉO CUMPRIDA",
                "PERIGO √Ä FRENTE\nFIQUE NAS SOMBRAS",
                "ENCONTRE AO MEIO DIA\nTRAGA O MAPA",
                "O ESPI√ÉO EST√Å PERTO\nN√ÉO CONFIE EM NINGU√âM",
                "C√ìDIGO VERMELHO\nEVACUE AGORA",
                "OLHE EMBAIXO DA PONTE\nO PACOTE EST√Å L√Å",
                "SIGA AS ESTRELAS\nO NORTE √â SEU GUIA",
                "O LE√ÉO DORME\nESPERE O SINAL",
                "QUEBRE O C√ìDIGO\nSALVE O MUNDO",
                "PULE O MURO\nCORRA PARA A LIBERDADE",
                "A LUA EST√Å CHEIA\nHORA DE AGIR",
                "ENCONTRE A PORTA SECRETA\nESCONDIDA NA CAVERNA",
                "N√ÉO CONFIE EM NINGU√âM\nVOC√ä EST√Å SOZINHO",
                "O TESOURO EST√Å ENTERRADO\nESCAVE SETE PASSOS",
                "OPERA√á√ÉO AURORA\nCOME√áA NO AMANHECER"
            ],
            id: [
                "HALO AGEN\nTEMUKAN HARTA KARUN",
                "ELANG TELAH MENDARAT\nMISI SELESAI",
                "BAHAYA DI DEPAN\nTETAP DI BAYANGAN",
                "BERTEMU TENGAH MALAM\nBAWA PETA",
                "MATA MATA SUDAH DEKAT\nJANGAN PERCAYA SIAPAPUN",
                "PERINGATAN MERAH\nEVAKUASI SEKARANG",
                "LIHAT DI BAWAH JEMBATAN\nPAKET ADA DI SANA",
                "IKUTI BINTANG\nUTARA ADALAH PANDUAN",
                "SINGA SEDANG TIDUR\nTUNGGU SINYAL",
                "PECAHKAN KODE\nSELAMATKAN DUNIA",
                "LOMPATI TEMBOK\nLARI KE KEBEBASAN",
                "BULAN PENUH\nWAKTU UNTUK BERTINDAK",
                "TEMUKAN PINTU RAHASIA\nTERSEMBUNYI DI GUA",
                "JANGAN PERCAYA SIAPAPUN\nKAMU SENDIRIAN",
                "HARTA TERKUBUR\nGALI TUJUH LANGKAH",
                "OPERASI FAJAR\nDIMULAI SAAT SUBUH"
            ],
            de: [
                "HALLO AGENT\nFINDE DEN SCHATZ",
                "DER ADLER IST GELANDET\nMISSION ERF√úLLT",
                "GEFAHR VORAUS\nBLEIB IM SCHATTEN",
                "TREFFE UM MITTERNACHT\nBRING DIE KARTE",
                "DER SPION IST NAH\nVERTRAUE NIEMANDEM",
                "CODE ROT ALARM\nEVAKUIERE JETZT",
                "SCHAU UNTER DIE BR√úCKE\nDAS PAKET IST DA",
                "FOLGE DEN STERNEN\nNORDEN IST DEIN F√úHRER",
                "DER L√ñWE SCHL√ÑFT\nWARTE AUF DAS SIGNAL",
                "KNACKE DEN CODE\nRETTE DIE WELT",
                "SPRING √úBER DIE MAUER\nLAUF IN DIE FREIHEIT",
                "DER MOND IST VOLL\nZEIT ZU HANDELN",
                "FINDE DIE GEHEIMT√úR\nVERSTECKT IN DER H√ñHLE",
                "VERTRAUE NIEMANDEM\nDU BIST ALLEIN",
                "DER SCHATZ IST VERGRABEN\nGRAB SIEBEN SCHRITTE",
                "OPERATION MORGENROT\nBEGINNT BEI SONNENAUFGANG"
            ],
            fr: [
                "BONJOUR AGENT\nTROUVE LE TRESOR",
                "L AIGLE A ATTERRI\nMISSION ACCOMPLIE",
                "DANGER DEVANT\nRESTE DANS L OMBRE",
                "RETROUVE A MINUIT\nAPPORTE LA CARTE",
                "L ESPION EST PROCHE\nNE FAIS CONFIANCE A PERSONNE",
                "CODE ROUGE ALERTE\nEVACUE MAINTENANT",
                "REGARDE SOUS LE PONT\nLE COLIS EST LA",
                "SUIS LES ETOILES\nLE NORD EST TON GUIDE",
                "LE LION DORT\nATTENDS LE SIGNAL",
                "BRISE LE CODE\nSAUVE LE MONDE",
                "SAUTE LE MUR\nCOURS VERS LA LIBERTE",
                "LA LUNE EST PLEINE\nIL EST TEMPS D AGIR",
                "TROUVE LA PORTE SECRETE\nCACHEE DANS LA GROTTE",
                "NE FAIS CONFIANCE A PERSONNE\nTU ES SEUL",
                "LE TRESOR EST ENTERRE\nCREUSE SEPT PAS",
                "OPERATION AURORE\nCOMMENCE A L AUBE"
            ],
            ms: [
                "HELLO EJEN\nCARI HARTA KARUN",
                "HELANG TELAH MENDARAT\nMISI SELESAI",
                "BAHAYA DI HADAPAN\nTINGGAL DI BAYANG",
                "JUMPA TENGAH MALAM\nBAWA PETA",
                "PENGINTIP SUDAH DEKAT\nJANGAN PERCAYA SESIAPA",
                "AMARAN MERAH\nBEREDAR SEKARANG",
                "TENGOK DI BAWAH JAMBATAN\nPAKEJ ADA DI SANA",
                "IKUT BINTANG\nUTARA PANDUAN KAMU",
                "SINGA SEDANG TIDUR\nTUNGGU ISYARAT",
                "PECAH KOD\nSELAMAT DUNIA",
                "LOMPAT TEMBOK\nLARI KE KEBEBASAN",
                "BULAN PURNAMA\nMASA UNTUK BERTINDAK",
                "CARI PINTU RAHSIA\nTERSEMBUNYI DI GUA",
                "JANGAN PERCAYA SESIAPA\nKAMU SEORANG DIRI",
                "HARTA TERTANAM\nGALI TUJUH LANGKAH",
                "OPERASI FAJAR\nMULA SAAT SUBUH"
            ],
            ar: [
                "ŸÖÿ±ÿ≠ÿ®ÿß ÿπŸÖŸäŸÑŸä\nÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÉŸÜÿ≤",
                "ÿßŸÑŸÜÿ≥ÿ± Ÿáÿ®ÿ∑\nÿßŸÑŸÖŸáŸÖÿ© ÿßŸÉÿ™ŸÖŸÑÿ™",
                "ÿÆÿ∑ÿ± ÿßŸÖÿßŸÖŸÉ\nÿßÿ®ŸÇ ŸÅŸä ÿßŸÑÿ∏ŸÑ",
                "ÿßŸÑÿ™ŸÇŸä ŸÖŸÜÿ™ÿµŸÅ ÿßŸÑŸÑŸäŸÑ\nÿßÿ≠ÿ∂ÿ± ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©",
                "ÿßŸÑÿ¨ÿßÿ≥Ÿàÿ≥ ŸÇÿ±Ÿäÿ®\nŸÑÿß ÿ™ÿ´ŸÇ ÿ®ÿ£ÿ≠ÿØ",
                "ÿ™ÿ≠ÿ∞Ÿäÿ± ÿßÿ≠ŸÖÿ±\nÿßÿÆŸÑ ÿßŸÑÿßŸÜ",
                "ÿßŸÜÿ∏ÿ± ÿ™ÿ≠ÿ™ ÿßŸÑÿ¨ÿ≥ÿ±\nÿßŸÑÿ∑ÿ±ÿØ ŸáŸÜÿßŸÉ",
                "ÿßÿ™ÿ®ÿπ ÿßŸÑŸÜÿ¨ŸàŸÖ\nÿßŸÑÿ¥ŸÖÿßŸÑ ÿØŸÑŸäŸÑŸÉ",
                "ÿßŸÑÿßÿ≥ÿØ ŸÜÿßÿ¶ŸÖ\nÿßŸÜÿ™ÿ∏ÿ± ÿßŸÑÿßÿ¥ÿßÿ±ÿ©",
                "ÿßŸÅŸÉ ÿßŸÑÿ¥ŸÅÿ±ÿ©\nÿßŸÜŸÇÿ∞ ÿßŸÑÿπÿßŸÑŸÖ",
                "ÿßŸÇŸÅÿ≤ ŸÅŸàŸÇ ÿßŸÑÿ¨ÿØÿßÿ±\nÿßÿ±ŸÉÿ∂ ŸÜÿ≠Ÿà ÿßŸÑÿ≠ÿ±Ÿäÿ©",
                "ÿßŸÑŸÇŸÖÿ± ŸÖŸÉÿ™ŸÖŸÑ\nÿ≠ÿßŸÜ ŸàŸÇÿ™ ÿßŸÑÿ™ÿ≠ÿ±ŸÉ",
                "ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑÿ®ÿßÿ® ÿßŸÑÿ≥ÿ±Ÿä\nŸÖÿÆÿ®ÿ£ ŸÅŸä ÿßŸÑŸÉŸáŸÅ",
                "ŸÑÿß ÿ™ÿ´ŸÇ ÿ®ÿ£ÿ≠ÿØ\nÿßŸÜÿ™ Ÿàÿ≠ÿØŸÉ",
                "ÿßŸÑŸÉŸÜÿ≤ ŸÖÿØŸÅŸàŸÜ\nÿßÿ≠ŸÅÿ± ÿ≥ÿ®ÿπ ÿÆÿ∑Ÿàÿßÿ™",
                "ÿπŸÖŸÑŸäÿ© ÿßŸÑŸÅÿ¨ÿ±\nÿ™ÿ®ÿØÿ£ ÿπŸÜÿØ ÿßŸÑÿ¥ÿ±ŸàŸÇ"
            ],
            ja: [
                "„Åì„Çì„Å´„Å°„ÅØ„Ç®„Éº„Ç∏„Çß„É≥„Éà\n„Åü„Åã„Çâ„Çí„Åï„Åå„Åõ",
                "„Çè„Åó„Åå„Å°„ÇÉ„Åè„Çä„Åè„Åó„Åü\n„Å´„ÇÄ„Åã„Çì„Çä„Çá„ÅÜ",
                "„Åæ„Åà„Å´„Åç„Åë„Çì„Åå„ÅÇ„Çã\n„Åã„Åí„Å´„ÅÑ„Çç",
                "„Åæ„Çà„Å™„Åã„Å´„ÅÇ„Åà\n„Å°„Åö„Çí„ÇÇ„Å£„Å¶„Åì„ÅÑ",
                "„Çπ„Éë„Ç§„Åå„Å°„Åã„ÅÑ\n„Å†„Çå„ÇÇ„Åó„Çì„Åò„Çã„Å™",
                "„ÅÇ„Åã„ÅÑ„Åë„ÅÑ„Åª„ÅÜ\n„Åô„Åê„Å´„Å≤„Å™„Çì„Åõ„Çà",
                "„ÅØ„Åó„ÅÆ„Åó„Åü„Çí„Åø„Çç\n„Å´„ÇÇ„Å§„Åå„ÅÇ„Çã",
                "„Åª„Åó„Çí„Åä„Åà\n„Åç„Åü„Åå„Åø„Å°„Åó„Çã„Åπ",
                "„É©„Ç§„Ç™„É≥„Åå„Å≠„ÇÄ„Çã\n„ÅÇ„ÅÑ„Åö„Çí„Åæ„Å¶",
                "„Ç≥„Éº„Éâ„Çí„Åã„ÅÑ„Åë„Å§\n„Åõ„Åã„ÅÑ„Çí„Åô„Åè„Åà",
                "„Åã„Åπ„Çí„Å®„Å≥„Åì„Åà„Çç\n„Åò„ÇÜ„ÅÜ„Å∏„ÅØ„Åó„Çå",
                "„Å§„Åç„Åå„Åø„Å°„Å¶„ÅÑ„Çã\n„ÅÜ„Åî„Åè„Åò„Åã„Çì„Å†",
                "„Å≤„Åø„Å§„ÅÆ„Å®„Å≥„Çâ„Çí„Åï„Åå„Åõ\n„Å©„ÅÜ„Åè„Å§„Å´„Åã„Åè„Çå„Å¶„ÅÑ„Çã",
                "„Å†„Çå„ÇÇ„Åó„Çì„Åò„Çã„Å™\n„Å≤„Å®„Çä„Å†",
                "„Åü„Åã„Çâ„ÅØ„ÅÜ„ÇÅ„Çâ„Çå„Å¶„ÅÑ„Çã\n„Å≤„Åå„Åó„Å´„Åô„Åô„ÇÅ",
                "„Åï„Åè„Åõ„Çì„ÅØ„Åò„Åæ„Çä\n„ÅÇ„Åã„Å§„Åç„Å´„Åù„Å™„Åà„Çà"
            ]
        };

        let currentLang = 'en';
        let lastMsgIndex = -1;

        function pickRandomMessage(lang) {
            const bank = messageBanks[lang] || messageBanks['en'];
            let idx;
            do { idx = Math.floor(Math.random() * bank.length); } while (idx === lastMsgIndex && bank.length > 1);
            lastMsgIndex = idx;
            return bank[idx];
        }

        function updateTheme() {
            document.body.setAttribute('data-theme', document.getElementById('themeSelect').value);
        }

        function toggleAnswers() {
            document.body.classList.toggle('show-answers');
        }

        function applyLanguage() {
            currentLang = document.getElementById('langSelect').value;
            const L = languages[currentLang];
            document.getElementById('custTitle').value  = L.ui.title;
            document.getElementById('custInstr').value  = L.ui.instr;
            document.getElementById('lblAgent').value   = L.ui.agent;
            document.getElementById('lblDate').value    = L.ui.date;
            document.getElementById('custFooter').value = L.ui.footer;
            document.getElementById('langNote').innerText = L.ui.note;
            lastMsgIndex = -1;
            document.getElementById('secretInput').value = pickRandomMessage(currentLang);
            renderWithCurrentMsg();
        }

        function render() {
            // Called by Encrypt button: pick a fresh random message then render
            document.getElementById('secretInput').value = pickRandomMessage(currentLang);
            renderWithCurrentMsg();
        }

        function renderWithCurrentMsg() {
            const L = languages[currentLang];
            const { alphabet, vowels, accentMap } = L;
            const currentSymbols = symbols[document.getElementById('symbolSet').value];
            const difficulty = document.getElementById('difficulty').value;

            // Update worksheet labels
            document.getElementById('out-title').innerText        = document.getElementById('custTitle').value;
            document.getElementById('out-instr').innerText        = document.getElementById('custInstr').value;
            document.getElementById('out-agent-label').innerText  = document.getElementById('lblAgent').value;
            document.getElementById('out-date-label').innerText   = document.getElementById('lblDate').value;
            document.getElementById('out-footer').innerText       = document.getElementById('custFooter').value;
            document.getElementById('out-stamp').innerText        = L.ui.stamp;
            document.getElementById('out-decoder-title').innerText = L.ui.decoderKey;
            document.getElementById('code-id').innerText          = "#" + Math.floor(Math.random() * 9999);

            // Build cipher map
            let cipherMap = {};
            alphabet.forEach((char, idx) => {
                if (idx < currentSymbols.length) cipherMap[char] = currentSymbols[idx];
            });

            // Normalise message
            const rawMsg = document.getElementById('secretInput').value;
            const msg = L.latinBased ? rawMsg.toUpperCase() : rawMsg;

            // Render message rows
            const msgContainer = document.getElementById('message-container');
            msgContainer.innerHTML = '';
            msg.split('\n').forEach(line => {
                let rowHtml = '<div class="message-row">';
                for (const char of line) {
                    if (char === ' ') { rowHtml += '<div class="spacer"></div>'; continue; }
                    const cipherChar = accentMap[char] !== undefined ? accentMap[char] : char;
                    if (cipherMap[cipherChar] !== undefined) {
                        rowHtml += `<div class="char-box">
                            <div class="symbol">${cipherMap[cipherChar]}</div>
                            <div class="answer-slot"><span class="answer-text">${char}</span></div>
                        </div>`;
                    }
                }
                rowHtml += '</div>';
                msgContainer.innerHTML += rowHtml;
            });

            // Render decoder key
            const keyGrid = document.getElementById('key-grid');
            keyGrid.innerHTML = '';
            alphabet.forEach((char, idx) => {
                if (idx >= currentSymbols.length) return;
                const displayChar = (difficulty === 'hard' && vowels.includes(char)) ? '?' : char;
                keyGrid.innerHTML += `<div class="key-item">
                    <div class="key-sym">${cipherMap[char]}</div>
                    <div class="key-char">${displayChar}</div>
                </div>`;
            });
        }

        window.onload = () => { applyLanguage(); };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script>
    function saveAsImage() {
        const target = document.querySelector(".worksheet-wrapper");
        const isChrome = /Chrome/.test(navigator.userAgent) && !/Firefox/.test(navigator.userAgent);
        html2canvas(target, { scale: isChrome ? 1.5 : 2, useCORS: true, backgroundColor: "#ffffff" }).then(canvas => {
            const link = document.createElement("a");
            link.download = "secret-code-worksheet.png";
            link.href = canvas.toDataURL("image/png");
            link.click();
        });
    }
    </script>
</body>
</html>
